#!/usr/bin/env bash
set -euo pipefail

# Configure PHP version here (e.g., "8.4", "8.5", "8.6")
PHP_VERSION="${PHP_VERSION:-8.4}"

# Docker image tag (override via PHP_IMAGE env var)
IMAGE="${PHP_IMAGE:-my/php:${PHP_VERSION}-dev}"

if [[ -n "${PHP_NETWORK:-}" ]]; then
  NETWORK="$PHP_NETWORK"
elif docker network inspect env_system >/dev/null 2>&1; then
  NETWORK="env_system"
else
  NETWORK="bridge"
fi

CACHE_DIR_HOST="${XDG_CACHE_HOME:-$HOME/.cache}/composer"
mkdir -p "$CACHE_DIR_HOST"

# Set up config directory for tools that need it
CONFIG_DIR_HOST="${XDG_CONFIG_HOME:-$HOME/.config}"
mkdir -p "$CONFIG_DIR_HOST"

# Check if TTY is available (for git hooks and non-interactive contexts)
# Only add TTY flags when a TTY is actually available
TTY_FLAGS=""
if [ -t 0 ] && [ -t 1 ]; then
  TTY_FLAGS="-it"
fi

exec docker run --rm $TTY_FLAGS \
  -u "$(id -u)":"$(id -g)" \
  --network "$NETWORK" \
  --add-host=host.docker.internal:host-gateway \
  -v "$PWD":/app -w /app \
  -v "$CACHE_DIR_HOST":/tmp/composer-cache \
  -v "$CONFIG_DIR_HOST":/tmp/.config \
  -e COMPOSER_CACHE_DIR=/tmp/composer-cache \
  -e HOME=/tmp \
  -e XDG_CONFIG_HOME=/tmp/.config \
  "$IMAGE" \
  composer "$@"
