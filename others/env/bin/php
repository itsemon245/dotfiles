#!/usr/bin/env bash
set -euo pipefail

# Configure PHP version here (e.g., "8.4", "8.5", "8.6")
PHP_VERSION="${PHP_VERSION:-8.4}"

# Docker image tag (override via PHP_IMAGE env var)
IMAGE="${PHP_IMAGE:-my/php:${PHP_VERSION}-dev}"
PORT_RANGE="${PHP_PORT_RANGE:-8000-8007}"

# Prefer the user's env var, else prefer env_system if present, else bridge
if [[ -n "${PHP_NETWORK:-}" ]]; then
  NETWORK="$PHP_NETWORK"
elif docker network inspect env_system >/dev/null 2>&1; then
  NETWORK="env_system"
else
  NETWORK="bridge"
fi

CACHE_DIR_HOST="${XDG_CACHE_HOME:-$HOME/.cache}/composer"
mkdir -p "$CACHE_DIR_HOST"

# Set up config directory for psysh/tinker and other tools
CONFIG_DIR_HOST="${XDG_CONFIG_HOME:-$HOME/.config}"
mkdir -p "$CONFIG_DIR_HOST"

# Check if this is a server command that needs port mapping
NEEDS_PORTS=false
if [[ $# -gt 0 ]]; then
  # Check for --host or --port flags (indicates server command)
  # Handle both --flag and --flag=value formats
  for arg in "$@"; do
    case "$arg" in
      --host|--port|-H|-p)
        NEEDS_PORTS=true
        break
        ;;
      --host=*|--port=*)
        NEEDS_PORTS=true
        break
        ;;
    esac
  done
  
  # Check command name if flags weren't found
  if [[ "$NEEDS_PORTS" == "false" ]]; then
    case "$1" in
      serve|octane|roadrunner|start|server)
        NEEDS_PORTS=true
        ;;
      artisan)
        # Check second argument for artisan server commands
        if [[ $# -gt 1 ]]; then
          case "$2" in
            serve|start)
              NEEDS_PORTS=true
              ;;
          esac
          # Check if it starts with octane or roadrunner (e.g., octane:start, roadrunner:serve)
          if [[ "$2" =~ ^(octane|roadrunner) ]]; then
            NEEDS_PORTS=true
          fi
          # Reverb server needs port exposure (e.g., reverb:start)
          if [[ "$2" =~ ^reverb ]]; then
            NEEDS_PORTS=true
          fi
        fi
        ;;
    esac
  fi
fi

# Build docker run command
DOCKER_ARGS=(
  --rm
  -u "$(id -u)":"$(id -g)"
  --network "$NETWORK"
  --dns 8.8.8.8
  --dns 1.1.1.1
  --add-host=host.docker.internal:host-gateway
  -v "$PWD":/app -w /app
  -v "$CACHE_DIR_HOST":/tmp/composer-cache
  -v "$CONFIG_DIR_HOST":/tmp/.config
  -e COMPOSER_CACHE_DIR=/tmp/composer-cache
  -e HOME=/tmp
  -e XDG_CONFIG_HOME=/tmp/.config
)

# Check if TTY is available (for git hooks and non-interactive contexts)
# Only add TTY flags when a TTY is actually available
# For git hooks and non-interactive contexts, don't use any TTY flags
if [ -t 0 ] && [ -t 1 ]; then
  DOCKER_ARGS+=(-it)
fi

# Only add port mapping for server commands
if [[ "$NEEDS_PORTS" == "true" ]]; then
  # Default to configured range; allow overriding via PHP_PORT_RANGE
  PORT_SPEC="${PORT_RANGE:-8000-8007}"

  # If running a simple serve command, map only the requested port (default 8000)
  if [[ "$1" == "serve" || ( "$1" == "artisan" && $# -gt 1 && "$2" == "serve" ) ]]; then
    SERVE_PORT="8000"
    ARGS=("$@")
    for ((i=0; i<${#ARGS[@]}; i++)); do
      case "${ARGS[$i]}" in
        --port=*)
          SERVE_PORT="${ARGS[$i]#*=}"
          ;;
        --port)
          if (( i + 1 < ${#ARGS[@]} )); then SERVE_PORT="${ARGS[$i+1]}"; fi
          ;;
        -p)
          if (( i + 1 < ${#ARGS[@]} )); then SERVE_PORT="${ARGS[$i+1]}"; fi
          ;;
      esac
    done
    PORT_SPEC="${SERVE_PORT}:${SERVE_PORT}"
  fi

  # Narrow to a single port for Reverb to avoid colliding with an existing serve container
  if [[ "$1" == "artisan" && $# -gt 1 && "$2" =~ ^reverb ]]; then
    SERVER_PORT="${REVERB_SERVER_PORT:-8008}"
    HOST_PORT="${REVERB_HOST_PORT:-$SERVER_PORT}"
    PORT_SPEC="${HOST_PORT}:${SERVER_PORT}"
  fi

  # If PORT_SPEC already includes host:container, use as-is; otherwise map same range both sides
  if [[ "$PORT_SPEC" == *:* ]]; then
    DOCKER_ARGS+=(-p "$PORT_SPEC")
  else
    DOCKER_ARGS+=(-p "${PORT_SPEC}:${PORT_SPEC}")
  fi
fi

# Convert absolute paths to relative paths for Docker container
# If lint-staged or other tools pass absolute paths, convert them to relative
CONVERTED_ARGS=()
for arg in "$@"; do
  # Check if argument is an absolute path that's within the current directory
  if [[ "$arg" == /* ]] && [[ "$arg" == "$PWD"/* ]]; then
    # Convert absolute path to relative path (remove $PWD prefix)
    # Handle both $PWD/file and $PWD cases
    if [[ "$arg" == "$PWD" ]]; then
      RELATIVE_PATH="."
    else
      RELATIVE_PATH="${arg#$PWD/}"
    fi
    CONVERTED_ARGS+=("$RELATIVE_PATH")
  else
    CONVERTED_ARGS+=("$arg")
  fi
done

exec docker run "${DOCKER_ARGS[@]}" "$IMAGE" php "${CONVERTED_ARGS[@]}"
