#!/usr/bin/env bash

# Package manager wrapper that auto-detects distro and supports common operations

set -uo pipefail

# Colors (if colors.sh is available)
if [ -f "$(dirname "$0")/../../colors.sh" ]; then
    source "$(dirname "$0")/../../colors.sh"
else
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    CYAN='\033[0;36m'
    NC='\033[0m' # No Color
fi

# Detect distribution
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        case "$ID" in
            arch|archlinux|manjaro|endeavouros)
                echo "arch"
                ;;
            debian|ubuntu|pop)
                echo "debian"
                ;;
            *)
                echo "unknown"
                ;;
        esac
    else
        echo "unknown"
    fi
}

# Get TOML file path for distro
# First tries ~/packages/$distro.toml, then falls back to ~/dotfiles/others/packages/$distro.toml
# If neither exists, returns primary path for new file creation
get_toml_path() {
    local distro=$1
    local primary_path="$HOME/packages/${distro}.toml"
    local fallback_path="$HOME/dotfiles/others/packages/${distro}.toml"
    
    # Try primary path first
    if [ -f "$primary_path" ]; then
        echo "$primary_path"
        return 0
    fi
    
    # Try fallback path
    if [ -f "$fallback_path" ]; then
        echo "$fallback_path"
        return 0
    fi
    
    # Neither exists - return primary path for new file creation
    echo "$primary_path"
}

# Check if package exists in a TOML file (ignores comments)
package_in_toml() {
    local distro=$1
    local package=$2
    local toml_file=$(get_toml_path "$distro")
    
    if [ ! -f "$toml_file" ]; then
        return 1
    fi
    
    # Check for exact package name, ignoring comments and empty lines
    while IFS= read -r line || [ -n "$line" ]; do
        # Remove inline comments (everything after #)
        line="${line%%#*}"
        # Trim whitespace
        line=$(echo "$line" | xargs)
        # Skip empty lines and comment-only lines
        [ -z "$line" ] && continue
        # Check if it matches the package name exactly
        [ "$line" = "$package" ] && return 0
    done < "$toml_file"
    
    return 1
}

# Check if package exists in both distro TOML files
package_in_both_tomls() {
    local package=$1
    package_in_toml "arch" "$package" && package_in_toml "debian" "$package"
}

# Check if package exists in Arch repositories (pacman or AUR)
package_exists_arch() {
    local package=$1
    
    # Check pacman first
    if pacman -Si "$package" &>/dev/null; then
        return 0
    fi
    
    # Check AUR helpers
    if command -v yay &>/dev/null && yay -Si "$package" &>/dev/null; then
        return 0
    fi
    
    if command -v paru &>/dev/null && paru -Si "$package" &>/dev/null; then
        return 0
    fi
    
    return 1
}

# Check if package exists in Debian repositories (apt)
package_exists_debian() {
    local package=$1
    
    # Check apt cache
    if apt-cache show "$package" &>/dev/null; then
        return 0
    fi
    
    return 1
}

# Check if package exists in the other distro's package repositories
package_exists_other_distro() {
    local current_distro=$1
    local package=$2
    
    if [ "$current_distro" = "arch" ]; then
        package_exists_debian "$package"
    else
        package_exists_arch "$package"
    fi
}

# Update TOML file with package (preserves comments)
update_toml() {
    local distro=$1
    local package_manager=$2
    local package=$3
    local toml_file=$(get_toml_path "$distro")
    
    # Create directory if it doesn't exist
    mkdir -p "$(dirname "$toml_file")"
    
    # Create file with sections if it doesn't exist
    if [ ! -f "$toml_file" ]; then
        case "$distro" in
            arch)
                cat > "$toml_file" <<EOF
[pacman]

[yay]

[paru]
EOF
                ;;
            debian)
                cat > "$toml_file" <<EOF
[apt]
EOF
                ;;
        esac
    fi
    
    # Check if package already exists in TOML (ignoring comments)
    if package_in_toml "$distro" "$package"; then
        return 0
    fi
    
    # Add package to appropriate section
    local section="[$package_manager]"
    local temp_file=$(mktemp)
    local in_section=0
    local inserted=0
    local section_found=0
    
    while IFS= read -r line || [ -n "$line" ]; do
        # Preserve the original line for comments
        local original_line="$line"
        
        # Check if we're entering the target section
        if [ "$line" = "$section" ]; then
            section_found=1
            in_section=1
            echo "$original_line" >> "$temp_file"
            # Insert package right after section header (if not already there)
            if [ $inserted -eq 0 ]; then
                echo "$package" >> "$temp_file"
                inserted=1
            fi
        # Check if we're entering a different section
        elif [[ "$line" =~ ^\[.*\]$ ]]; then
            in_section=0
            echo "$original_line" >> "$temp_file"
        # Regular line - preserve it (including comments)
        else
            echo "$original_line" >> "$temp_file"
        fi
    done < "$toml_file"
    
    # If section doesn't exist, add it at the end
    if [ $section_found -eq 0 ]; then
        echo "" >> "$temp_file"
        echo "$section" >> "$temp_file"
        echo "$package" >> "$temp_file"
    fi
    
    mv "$temp_file" "$toml_file"
}

# Update TOML files for both distros if package is common
# Checks if package exists in the other distro's package repositories.
# If it exists in both distros' repositories, syncs to both TOML files.
update_toml_sync() {
    local current_distro=$1
    local package_manager=$2
    local package=$3
    
    # Determine the other distro
    if [ "$current_distro" = "arch" ]; then
        local other_distro="debian"
        local other_pm="apt"
    else
        local other_distro="arch"
        local other_pm="pacman"
    fi
    
    # Update current distro's TOML first
    update_toml "$current_distro" "$package_manager" "$package"
    
    # Check if package exists in the other distro's package repositories
    # This works for both existing packages in TOML and new packages
    if package_exists_other_distro "$current_distro" "$package"; then
        echo -e "${CYAN}Package $package exists in ${other_distro} repositories, updating ${other_distro}.toml...${NC}"
        update_toml "$other_distro" "$other_pm" "$package"
    fi
}

# Remove package from TOML file (checks all sections, preserves comments)
remove_from_toml() {
    local distro=$1
    local package_manager=$2
    local package=$3
    local toml_file=$(get_toml_path "$distro")
    
    if [ ! -f "$toml_file" ]; then
        return 0  # File doesn't exist, nothing to remove
    fi
    
    # Remove package from all sections where it appears
    local temp_file=$(mktemp)
    local in_section=0
    local package_found=0
    
    while IFS= read -r line || [ -n "$line" ]; do
        # Preserve the original line
        local original_line="$line"
        # Extract package name (remove inline comments and trim)
        local package_name="${line%%#*}"
        package_name=$(echo "$package_name" | xargs)
        
        # Check if we're entering any section
        if [[ "$line" =~ ^\[.*\]$ ]]; then
            in_section=1
            echo "$original_line" >> "$temp_file"
        # We're in a section - skip the package if it matches (ignoring comments)
        elif [ $in_section -eq 1 ] && [ "$package_name" = "$package" ] && [ -n "$package_name" ]; then
            package_found=1
            # Don't echo this line (remove it)
            continue
        # Regular line - preserve it (including comments)
        else
            echo "$original_line" >> "$temp_file"
        fi
    done < "$toml_file"
    
    mv "$temp_file" "$toml_file"
    
    if [ $package_found -eq 1 ]; then
        echo -e "${GREEN}Removed $package from ${distro}.toml${NC}"
    fi
}

# Remove package from TOML files for both distros if package is common
# Checks if package exists in the other distro's package repositories.
# If it exists in both distros' repositories, removes from both TOML files.
remove_from_toml_sync() {
    local current_distro=$1
    local package_manager=$2
    local package=$3
    
    # Determine the other distro
    if [ "$current_distro" = "arch" ]; then
        local other_distro="debian"
        local other_pm="apt"
    else
        local other_distro="arch"
        local other_pm="pacman"
    fi
    
    # Remove from current distro's TOML first
    remove_from_toml "$current_distro" "$package_manager" "$package"
    
    # Check if package exists in the other distro's package repositories
    # This works for both existing packages in TOML and new packages
    if package_exists_other_distro "$current_distro" "$package"; then
        echo -e "${CYAN}Package $package exists in ${other_distro} repositories, removing from ${other_distro}.toml...${NC}"
        remove_from_toml "$other_distro" "$other_pm" "$package"
    fi
}

# Install package on Arch with specific package manager
install_arch_with_pm() {
    local package=$1
    local package_manager=$2
    
    case "$package_manager" in
        pacman)
            if pacman -Si "$package" &>/dev/null; then
                echo -e "${CYAN}Installing $package via pacman...${NC}"
                if sudo pacman -S --noconfirm "$package"; then
                    return 0
                else
                    echo -e "${RED}Failed to install $package via pacman${NC}"
                    return 1
                fi
            else
                echo -e "${RED}Package $package not found in pacman${NC}"
                return 1
            fi
            ;;
        yay)
            if command -v yay &>/dev/null; then
                if yay -Si "$package" &>/dev/null; then
                    echo -e "${CYAN}Installing $package via yay...${NC}"
                    if yay -S --noconfirm "$package"; then
                        return 0
                    else
                        echo -e "${RED}Failed to install $package via yay${NC}"
                        return 1
                    fi
                else
                    echo -e "${RED}Package $package not found in yay${NC}"
                    return 1
                fi
            else
                echo -e "${RED}yay is not installed${NC}"
                return 1
            fi
            ;;
        paru)
            if command -v paru &>/dev/null; then
                if paru -Si "$package" &>/dev/null; then
                    echo -e "${CYAN}Installing $package via paru...${NC}"
                    if paru -S --noconfirm "$package"; then
                        return 0
                    else
                        echo -e "${RED}Failed to install $package via paru${NC}"
                        return 1
                    fi
                else
                    echo -e "${RED}Package $package not found in paru${NC}"
                    return 1
                fi
            else
                echo -e "${RED}paru is not installed${NC}"
                return 1
            fi
            ;;
        *)
            echo -e "${RED}Unknown package manager: $package_manager${NC}"
            return 1
            ;;
    esac
}

# Install package on Arch (auto-detect package manager)
install_arch() {
    local package=$1
    
    # Try pacman first
    if pacman -Si "$package" &>/dev/null; then
        echo -e "${CYAN}Installing $package via pacman...${NC}"
        if sudo pacman -S --noconfirm "$package"; then
            update_toml_sync "arch" "pacman" "$package"
            return 0
        else
            echo -e "${RED}Failed to install $package via pacman${NC}"
            return 1
        fi
    fi
    
    # Try yay if available
    if command -v yay &>/dev/null; then
        echo -e "${CYAN}Package not found in pacman, trying yay...${NC}"
        if yay -Si "$package" &>/dev/null; then
            echo -e "${CYAN}Installing $package via yay...${NC}"
            if yay -S --noconfirm "$package"; then
                update_toml_sync "arch" "yay" "$package"
                return 0
            else
                echo -e "${RED}Failed to install $package via yay${NC}"
                return 1
            fi
        fi
    fi
    
    # Try paru if available
    if command -v paru &>/dev/null; then
        echo -e "${CYAN}Package not found in yay, trying paru...${NC}"
        if paru -Si "$package" &>/dev/null; then
            echo -e "${CYAN}Installing $package via paru...${NC}"
            if paru -S --noconfirm "$package"; then
                update_toml_sync "arch" "paru" "$package"
                return 0
            else
                echo -e "${RED}Failed to install $package via paru${NC}"
                return 1
            fi
        fi
    fi
    
    echo -e "${RED}Package $package not found in pacman or AUR helpers${NC}"
    return 1
}

# Install package on Debian
install_debian() {
    local package=$1
    
    echo -e "${CYAN}Installing $package via apt...${NC}"
    sudo apt update
    if sudo apt install -y "$package"; then
        update_toml_sync "debian" "apt" "$package"
        return 0
    else
        return 1
    fi
}

# Remove package on Arch
remove_arch() {
    local package=$1
    local flags=${2:-"-Rns"}  # Default to -Rns (remove with dependencies and config)
    local package_manager=""
    
    # Try pacman first
    if pacman -Qi "$package" &>/dev/null; then
        echo -e "${CYAN}Removing $package via pacman...${NC}"
        if sudo pacman $flags --noconfirm "$package"; then
            package_manager="pacman"
        else
            return 1
        fi
    # Try yay if available
    elif command -v yay &>/dev/null && yay -Qi "$package" &>/dev/null; then
        echo -e "${CYAN}Removing $package via yay...${NC}"
        if yay $flags --noconfirm "$package"; then
            package_manager="yay"
        else
            return 1
        fi
    # Try paru if available
    elif command -v paru &>/dev/null && paru -Qi "$package" &>/dev/null; then
        echo -e "${CYAN}Removing $package via paru...${NC}"
        if paru $flags --noconfirm "$package"; then
            package_manager="paru"
        else
            return 1
        fi
    else
        echo -e "${RED}Package $package not found or not installed${NC}"
        return 1
    fi
    
    # Remove from TOML if removal was successful
    if [ -n "$package_manager" ]; then
        remove_from_toml_sync "arch" "$package_manager" "$package"
    fi
    
    return 0
}

# Remove package on Debian
remove_debian() {
    local package=$1
    
    echo -e "${CYAN}Removing $package via apt...${NC}"
    if sudo apt remove -y "$package"; then
        # Remove from TOML if removal was successful
        remove_from_toml_sync "debian" "apt" "$package"
        return 0
    else
        return 1
    fi
}

# Search packages on Arch
search_arch() {
    local query=$1
    
    echo -e "${CYAN}Searching pacman repositories for: $query${NC}"
    pacman -Ss "$query"
    
    if command -v yay &>/dev/null; then
        echo ""
        echo -e "${CYAN}Searching AUR (yay) for: $query${NC}"
        yay -Ss "$query"
    elif command -v paru &>/dev/null; then
        echo ""
        echo -e "${CYAN}Searching AUR (paru) for: $query${NC}"
        paru -Ss "$query"
    fi
}

# Search packages on Debian
search_debian() {
    local query=$1
    
    echo -e "${CYAN}Searching apt repositories for: $query${NC}"
    apt search "$query"
}

# Update package lists and upgrade packages
update_packages() {
    local distro=$(detect_distro)
    
    case "$distro" in
        arch)
            echo -e "${CYAN}Updating package database and upgrading packages...${NC}"
            sudo pacman -Syu --noconfirm
            if command -v yay &>/dev/null; then
                echo ""
                echo -e "${CYAN}Updating AUR packages (yay)...${NC}"
                yay -Syu --noconfirm
            elif command -v paru &>/dev/null; then
                echo ""
                echo -e "${CYAN}Updating AUR packages (paru)...${NC}"
                paru -Syu --noconfirm
            fi
            ;;
        debian)
            echo -e "${CYAN}Updating package lists and upgrading packages...${NC}"
            sudo apt update && sudo apt upgrade -y
            ;;
        *)
            echo -e "${RED}Unsupported distribution: $distro${NC}"
            return 1
            ;;
    esac
}

# Show package info
info_package() {
    local package=$1
    local distro=$(detect_distro)
    
    case "$distro" in
        arch)
            if pacman -Si "$package" &>/dev/null; then
                echo -e "${CYAN}Package info from pacman:${NC}"
                pacman -Si "$package"
            elif command -v yay &>/dev/null && yay -Si "$package" &>/dev/null; then
                echo -e "${CYAN}Package info from AUR (yay):${NC}"
                yay -Si "$package"
            elif command -v paru &>/dev/null && paru -Si "$package" &>/dev/null; then
                echo -e "${CYAN}Package info from AUR (paru):${NC}"
                paru -Si "$package"
            else
                echo -e "${RED}Package $package not found${NC}"
                return 1
            fi
            ;;
        debian)
            echo -e "${CYAN}Package info:${NC}"
            apt show "$package" 2>/dev/null || apt-cache show "$package" 2>/dev/null
            ;;
        *)
            echo -e "${RED}Unsupported distribution: $distro${NC}"
            return 1
            ;;
    esac
}

# List installed packages
list_installed() {
    local distro=$(detect_distro)
    local query=${1:-""}
    
    case "$distro" in
        arch)
            if [ -n "$query" ]; then
                pacman -Q | grep -i "$query"
            else
                pacman -Q
            fi
            ;;
        debian)
            if [ -n "$query" ]; then
                dpkg -l | grep -i "$query"
            else
                dpkg -l
            fi
            ;;
        *)
            echo -e "${RED}Unsupported distribution: $distro${NC}"
            return 1
            ;;
    esac
}

# Parse TOML file and extract packages by section
parse_toml_packages() {
    local toml_file=$1
    local section=""
    declare -A packages_by_section
    
    if [ ! -f "$toml_file" ]; then
        echo -e "${RED}TOML file not found: $toml_file${NC}"
        return 1
    fi
    
    while IFS= read -r line || [ -n "$line" ]; do
        # Preserve original line for section headers
        local original_line="$line"
        
        # Remove inline comments (everything after #)
        line="${line%%#*}"
        # Remove leading/trailing whitespace
        line=$(echo "$line" | xargs)
        
        # Skip empty lines and comment-only lines
        [ -z "$line" ] && continue
        
        # Check if it's a section header (use original line to preserve comments in section)
        if [[ "$original_line" =~ ^\[.*\] ]]; then
            section="${original_line%%#*}"  # Remove comments from section name
            section="${section//[\[\]]/}"
            section=$(echo "$section" | xargs)
            packages_by_section["$section"]=""
        # It's a package name (non-empty line that's not a section header)
        elif [ -n "$section" ] && [ -n "$line" ]; then
            if [ -z "${packages_by_section[$section]}" ]; then
                packages_by_section["$section"]="$line"
            else
                packages_by_section["$section"]="${packages_by_section[$section]} $line"
            fi
        fi
    done < "$toml_file"
    
    # Output packages by section
    for section in "${!packages_by_section[@]}"; do
        echo "${section}:${packages_by_section[$section]}"
    done
}

# Install all packages from TOML file
install_all_from_toml() {
    local distro=$(detect_distro)
    local toml_file=$(get_toml_path "$distro")
    local failed_packages_file=$(mktemp)
    
    if [ ! -f "$toml_file" ]; then
        echo -e "${RED}TOML file not found: $toml_file${NC}"
        echo -e "${YELLOW}Run '$0 <package-name>' to install packages first${NC}"
        return 1
    fi
    
    echo -e "${CYAN}Installing all packages from $toml_file...${NC}"
    echo ""
    
    local parsed_packages
    
    # Parse TOML file
    parsed_packages=$(parse_toml_packages "$toml_file")
    
    case "$distro" in
        arch)
            # Install pacman packages first
            local pacman_pkgs=$(echo "$parsed_packages" | grep "^pacman:" | cut -d: -f2-)
            if [ -n "$pacman_pkgs" ]; then
                echo -e "${CYAN}=== Installing pacman packages ===${NC}"
                for package in $pacman_pkgs; do
                    [ -z "$package" ] && continue
                    if ! install_arch_with_pm "$package" "pacman"; then
                        echo "$package" >> "$failed_packages_file"
                    fi
                done
            fi
            
            # Install yay packages
            local yay_pkgs=$(echo "$parsed_packages" | grep "^yay:" | cut -d: -f2-)
            if [ -n "$yay_pkgs" ] && command -v yay &>/dev/null; then
                echo ""
                echo -e "${CYAN}=== Installing yay packages ===${NC}"
                for package in $yay_pkgs; do
                    [ -z "$package" ] && continue
                    if ! install_arch_with_pm "$package" "yay"; then
                        echo "$package" >> "$failed_packages_file"
                    fi
                done
            elif [ -n "$yay_pkgs" ]; then
                echo ""
                echo -e "${YELLOW}Warning: yay packages found but yay is not installed. Skipping yay packages.${NC}"
            fi
            
            # Install paru packages
            local paru_pkgs=$(echo "$parsed_packages" | grep "^paru:" | cut -d: -f2-)
            if [ -n "$paru_pkgs" ] && command -v paru &>/dev/null; then
                echo ""
                echo -e "${CYAN}=== Installing paru packages ===${NC}"
                for package in $paru_pkgs; do
                    [ -z "$package" ] && continue
                    if ! install_arch_with_pm "$package" "paru"; then
                        echo "$package" >> "$failed_packages_file"
                    fi
                done
            elif [ -n "$paru_pkgs" ]; then
                echo ""
                echo -e "${YELLOW}Warning: paru packages found but paru is not installed. Skipping paru packages.${NC}"
            fi
            ;;
        debian)
            # Install apt packages
            local apt_pkgs=$(echo "$parsed_packages" | grep "^apt:" | cut -d: -f2-)
            if [ -n "$apt_pkgs" ]; then
                echo -e "${CYAN}=== Installing apt packages ===${NC}"
                echo -e "${CYAN}Updating package lists...${NC}"
                sudo apt update
                for package in $apt_pkgs; do
                    [ -z "$package" ] && continue
                    echo -e "${CYAN}Installing $package via apt...${NC}"
                    if ! sudo apt install -y "$package"; then
                        echo "$package" >> "$failed_packages_file"
                    fi
                done
            fi
            ;;
        *)
            echo -e "${RED}Unsupported distribution: $distro${NC}"
            rm -f "$failed_packages_file"
            return 1
            ;;
    esac
    
    echo ""
    if [ -s "$failed_packages_file" ]; then
        local failed_list=$(cat "$failed_packages_file" | tr '\n' ' ')
        echo -e "${YELLOW}Warning: The following packages failed to install: ${failed_list}${NC}"
        rm -f "$failed_packages_file"
        return 1
    else
        echo -e "${GREEN}All packages installed successfully!${NC}"
        rm -f "$failed_packages_file"
        return 0
    fi
}

# Main install function
install_package() {
    local package=$1
    local distro=$(detect_distro)
    
    if [ -z "$package" ]; then
        echo -e "${RED}Usage: $0 <package-name>${NC}"
        exit 1
    fi
    
    case "$distro" in
        arch)
            install_arch "$package"
            ;;
        debian)
            install_debian "$package"
            ;;
        *)
            echo -e "${RED}Unsupported distribution: $distro${NC}"
            exit 1
            ;;
    esac
}

# Parse command/operation from arguments
parse_operation() {
    local first_arg=$1
    
    # Handle special flags and commands
    case "$first_arg" in
        --all|-a)
            echo "install_all"
            return 0
            ;;
        -R|-Rns|--remove|remove|uninstall)
            echo "remove"
            return 0
            ;;
        -Ss|--search|search)
            echo "search"
            return 0
            ;;
        -Syu|-Sy|--update|update|upgrade)
            echo "update"
            return 0
            ;;
        -Si|--info|info)
            echo "info"
            return 0
            ;;
        -Q|-Qe|-Qm|--list|list)
            echo "list"
            return 0
            ;;
        -S|--install|install)
            echo "install"
            return 0
            ;;
    esac
    
    # Check for pacman-style flags (Arch)
    if [[ "$first_arg" =~ ^-R ]]; then
        echo "remove"
        return 0
    fi
    
    if [[ "$first_arg" =~ ^-Q ]]; then
        echo "list"
        return 0
    fi
    
    # Default to install (package name provided directly)
    echo "install"
}

# Main argument parsing
if [ $# -eq 0 ]; then
    echo -e "${CYAN}Package Manager Wrapper${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  $0 [operation] [packages...]"
    echo ""
    echo -e "${CYAN}Operations:${NC}"
    echo "  install, -S          Install packages (default)"
    echo "  --all, -a             Install all packages from TOML file"
    echo "  remove, -R, -Rns      Remove packages"
    echo "  search, -Ss           Search for packages"
    echo "  update, -Syu, upgrade Update package lists and upgrade"
    echo "  info, -Si             Show package information"
    echo "  list, -Q              List installed packages"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  $0 --all                    # Install all packages from TOML"
    echo "  $0 kitty tmux zsh           # Install packages (default)"
    echo "  $0 -S kitty                 # Install package (explicit)"
    echo "  $0 -Rns chromium            # Remove package (Arch: pacman style)"
    echo "  $0 remove kitty             # Remove package (Debian: apt style)"
    echo "  $0 -R chromium              # Remove package (Arch: simple)"
    echo "  $0 -Ss neovim               # Search for packages (Arch)"
    echo "  $0 search neovim            # Search for packages (Debian)"
    echo "  $0 -Syu                     # Update and upgrade (Arch)"
    echo "  $0 update                   # Update and upgrade (Debian)"
    echo "  $0 -Si chromium             # Show package info (Arch)"
    echo "  $0 info chromium            # Show package info (Debian)"
    echo "  $0 -Q                       # List installed packages (Arch)"
    echo "  $0 list                     # List installed packages (Debian)"
    exit 1
fi

operation=$(parse_operation "$1")

# Handle operations
case "$operation" in
    install_all)
        install_all_from_toml
        exit $?
        ;;
    remove)
        # Extract removal flags if present
        remove_flags="-Rns"
        if [[ "$1" =~ ^-R ]]; then
            remove_flags="$1"
            shift
        elif [[ "$1" =~ ^(--remove|remove|uninstall)$ ]]; then
            shift
        fi
        
        if [ $# -eq 0 ]; then
            echo -e "${RED}Error: No packages specified for removal${NC}"
            exit 1
        fi
        
        distro=$(detect_distro)
        failed_packages=()
        for package in "$@"; do
            case "$distro" in
                arch)
                    if ! remove_arch "$package" "$remove_flags"; then
                        failed_packages+=("$package")
                    fi
                    ;;
                debian)
                    if ! remove_debian "$package"; then
                        failed_packages+=("$package")
                    fi
                    ;;
                *)
                    echo -e "${RED}Unsupported distribution: $distro${NC}"
                    exit 1
                    ;;
            esac
        done
        
        if [ ${#failed_packages[@]} -gt 0 ]; then
            echo -e "${YELLOW}Warning: Failed to remove: ${failed_packages[*]}${NC}"
            exit 1
        fi
        ;;
    search)
        # Check if first arg is the operation flag/command
        if [[ "$1" =~ ^(-Ss|--search|search)$ ]]; then
            shift
        fi
        
        if [ $# -eq 0 ]; then
            echo -e "${RED}Error: No search query specified${NC}"
            exit 1
        fi
        
        distro=$(detect_distro)
        for query in "$@"; do
            case "$distro" in
                arch)
                    search_arch "$query"
                    ;;
                debian)
                    search_debian "$query"
                    ;;
                *)
                    echo -e "${RED}Unsupported distribution: $distro${NC}"
                    exit 1
                    ;;
            esac
        done
        ;;
    update)
        update_packages
        exit $?
        ;;
    info)
        # Check if first arg is the operation flag/command
        if [[ "$1" =~ ^(-Si|--info|info)$ ]]; then
            shift
        fi
        
        if [ $# -eq 0 ]; then
            echo -e "${RED}Error: No package specified${NC}"
            exit 1
        fi
        
        for package in "$@"; do
            info_package "$package"
            echo ""
        done
        ;;
    list)
        # Check if first arg is the operation flag/command
        if [[ "$1" =~ ^(-Q|-Qe|-Qm|--list|list)$ ]]; then
            shift
        fi
        list_installed "$@"
        ;;
    install)
        # Check if first arg is the operation flag/command and remove it
        if [[ "$1" =~ ^(-S|--install|install)$ ]]; then
            shift
        fi
        
        if [ $# -eq 0 ]; then
            echo -e "${RED}Error: No packages specified${NC}"
            exit 1
        fi
        
        failed_packages=()
        for package in "$@"; do
            if ! install_package "$package"; then
                failed_packages+=("$package")
            fi
        done
        
        if [ ${#failed_packages[@]} -gt 0 ]; then
            echo -e "${RED}Error: The following packages failed to install: ${failed_packages[*]}${NC}"
            exit 1
        fi
        
        echo -e "${GREEN}All packages installed successfully!${NC}"
        ;;
    *)
        echo -e "${RED}Unknown operation: $operation${NC}"
        exit 1
        ;;
esac
