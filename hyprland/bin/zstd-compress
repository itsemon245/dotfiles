#!/usr/bin/env bash

# ==============================================================================
# ZSTD COMPRESSION (Raw PV Output + PID Tracking)
# ==============================================================================

ZSTD_ARGS="-T0 --long -15"
LOG_FILE="/tmp/zstd-compress-last.log"
FIFO="/tmp/zstd_progress_$$"

# --- Setup Logging & Cleanup ---
echo "Starting Job: $(date)" > "$LOG_FILE"

cleanup() {
    # Remove the named pipe
    [ -p "$FIFO" ] && rm "$FIFO"

    # Kill the background compression process if it's still running
    if [ -n "$COMPRESS_PID" ]; then
        if ps -p $COMPRESS_PID > /dev/null; then
            echo "Killing process $COMPRESS_PID" >> "$LOG_FILE"
            kill $COMPRESS_PID 2>/dev/null
            wait $COMPRESS_PID 2>/dev/null
            # If we killed it, it means it was incomplete, so delete archive
            [ -f "$ARCHIVE_NAME" ] && rm -f "$ARCHIVE_NAME"
        fi
    fi
}
trap cleanup EXIT

# --- Input Validation ---
TARGET="$1"
MODE="$2"

if [ -z "$TARGET" ]; then
    notify-send "Error" "No input provided" -u critical
    exit 1
fi

TARGET_PATH=$(realpath "$TARGET")
PARENT_DIR=$(dirname "$TARGET_PATH")
ITEM_NAME=$(basename "$TARGET_PATH")
ARCHIVE_NAME="${ITEM_NAME}.tar.zst"

echo "Input: $TARGET_PATH" >> "$LOG_FILE"

if [ ! -e "$TARGET_PATH" ]; then
    notify-send "Error" "Path not found: $TARGET_PATH" -u critical
    exit 1
fi

cd "$PARENT_DIR" || exit 1

# Calculate Size
if [ -d "$ITEM_NAME" ]; then
    TOTAL_SIZE=$(du -sb "$ITEM_NAME" | awk '{print $1}')
else
    TOTAL_SIZE=$(stat -c%s "$ITEM_NAME")
fi
echo "Total Bytes: $TOTAL_SIZE" >> "$LOG_FILE"

# --- GUI Execution Logic ---

run_gui() {
    # 1. Create a Named Pipe
    mkfifo "$FIFO"

    # 2. Start Compression in BACKGROUND
    #    We use standard 'pv -f' (force) which outputs the human text (ETA, Speed).
    #    We redirect stderr (2>) to the FIFO.
    (
        set -o pipefail
        tar -cf - "$ITEM_NAME" 2>/dev/null | \
        pv --force --si --interval 0.5 -s "$TOTAL_SIZE" 2> "$FIFO" | \
        zstd $ZSTD_ARGS > "$ARCHIVE_NAME"
    ) &

    # Save the Process ID (PID) to control the Cancel button
    COMPRESS_PID=$!
    echo "Compression PID: $COMPRESS_PID" >> "$LOG_FILE"

    # 3. Start Zenity in FOREGROUND
    #    We read raw pv text from the FIFO.
    #    We use RS="\r" because pv uses carriage returns to update the line.
    cat "$FIFO" | \
    awk '
        BEGIN { RS="\r"; ORS="\n" }
        {
            # 1. Update the Text Label (Show exactly what PV shows)
            print "# " $0;

            # 2. Extract the percentage number for the Zenity Bar
            if (match($0, /[0-9]+%/)) {
                print substr($0, RSTART, RLENGTH-1)
            }

            fflush();
        }' | \
    zenity --progress \
        --title="Compressing $ITEM_NAME" \
        --text="Initializing..." \
        --percentage=0 \
        --auto-close \
        --width=500

    # 4. Handle Exit
    # Check if the compression process is still running
    if ps -p $COMPRESS_PID > /dev/null; then
        # PROCESS IS ALIVE = USER HIT CANCEL
        echo "User cancelled via GUI." >> "$LOG_FILE"
        kill $COMPRESS_PID 2>/dev/null
        rm -f "$ARCHIVE_NAME"
        notify-send "Cancelled" "Compression aborted." -i dialog-warning
    else
        # PROCESS IS DEAD = COMPRESSION FINISHED (or crashed)
        wait $COMPRESS_PID
        EXIT_STATUS=$?

        if [ $EXIT_STATUS -eq 0 ]; then
             notify-send "Success" "$ARCHIVE_NAME Created." -i archive-insert
        else
             notify-send "Error" "Compression failed. Check log." -u critical
        fi
    fi
}

run_cli() {
    echo "Compressing $ITEM_NAME..."
    tar -cf - "$ITEM_NAME" | pv --si -s "$TOTAL_SIZE" | zstd $ZSTD_ARGS > "$ARCHIVE_NAME"
}

if [ "$MODE" == "--gui" ]; then
    run_gui
else
    run_cli
fi
