#!/usr/bin/env bash

# --- 1. SETUP & TRAP (Handle Ctrl+C) ---

# We define variables early so the trap function can find them
TARGET="$1"

# Function to handle User Abort (Ctrl+C)
handle_abort() {
    echo -e "\n\nüõë ABORTED BY USER (Ctrl+C)"
    echo "Cleaning up..."

    # Kill any running background jobs (just in case)
    jobs -p | xargs -r kill

    # Remove the partial archive if it exists
    if [ -n "$ARCHIVE_NAME" ] && [ -f "$ARCHIVE_NAME" ]; then
        rm -f "$ARCHIVE_NAME"
        echo "Removed partial file: $ARCHIVE_NAME"
    fi

    # Send Notification
    notify-send "Compression Cancelled" "Operation aborted by user." -u normal -i dialog-warning

    # Exit immediately
    exit 130
}

# Activate the trap for SIGINT (Ctrl+C)
trap handle_abort SIGINT

# --- 2. INPUT CHECKS ---

if [ -z "$TARGET" ]; then
    echo "Error: No input file."
    read -n 1 -s -r -p "Press any key to exit..."
    exit 1
fi

# Resolve paths
TARGET_PATH=$(realpath "$TARGET")
PARENT_DIR=$(dirname "$TARGET_PATH")
ITEM_NAME=$(basename "$TARGET_PATH")
ARCHIVE_NAME="${ITEM_NAME}.tar.zst"

# Check existence
if [ ! -e "$TARGET_PATH" ]; then
    echo "Error: Target not found: $TARGET_PATH"
    read -n 1 -s -r -p "Press any key to exit..."
    exit 1
fi

cd "$PARENT_DIR" || exit 1

# Calculate Size (for PV progress bar)
echo "Calculating size of: $ITEM_NAME"
if [ -d "$ITEM_NAME" ]; then
    TOTAL_SIZE=$(du -sb "$ITEM_NAME" | awk '{print $1}')
else
    TOTAL_SIZE=$(stat -c%s "$ITEM_NAME")
fi

# --- 3. DISPLAY INFO ---

clear
echo "==================================================="
echo "           ZSTD HIGH COMPRESSION (PRO)             "
echo "==================================================="
echo " Input:      $ITEM_NAME"
echo " Archive:    $ARCHIVE_NAME"
echo " Size:       $(numfmt --to=iec --suffix=B $TOTAL_SIZE)"
echo " Settings:   Level 15 | Long Distance | Threads: Auto"
echo "---------------------------------------------------"
echo " üí° TIP: Press 'Ctrl + C' to Abort at any time."
echo "==================================================="
echo ""

# --- 4. RUN COMPRESSION ---

# We use pipefail so if tar fails, the whole status fails
set -o pipefail

tar -cf - "$ITEM_NAME" 2>/dev/null | \
pv -p -t -e -r -b --si -s "$TOTAL_SIZE" | \
zstd -T0 --long -15 > "$ARCHIVE_NAME"

STATUS=$?

echo ""
echo "==================================================="

# --- 5. FINISH HANDLING ---

if [ $STATUS -eq 0 ]; then
    echo "‚úÖ SUCCESS! Archive created successfully."
    notify-send "Compression Finished" "$ARCHIVE_NAME Ready" -i archive-insert

    # Wait for any key
    echo ""
    read -n 1 -s -r -p "Press ANY key to close window..."
else
    # This block runs if the command failed (not aborted via Ctrl+C)
    # e.g. Disk full, Permission denied
    echo "‚ùå FAILED. Error code: $STATUS"

    # Delete partial file
    [ -f "$ARCHIVE_NAME" ] && rm -f "$ARCHIVE_NAME"

    notify-send "Compression Failed" "Check terminal for error details" -u critical -i dialog-error

    # Wait for any key
    echo ""
    read -n 1 -s -r -p "Press ANY key to close window..."
fi
