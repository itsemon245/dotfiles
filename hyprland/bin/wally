#!/usr/bin/env bash

# ==============================================================================
# CONFIGURATION
# ==============================================================================

# Directory containing your wallpapers
WALLPAPER_DIR="$HOME/Wallpapers"

# The specific file Hyprland/swww should always look at
DEFAULT_WALLPAPER="$WALLPAPER_DIR/default.png"

# Directory to cache upscaled images
CACHE_DIR="$HOME/.cache/wally"

# Rofi Theme Path
ROFI_THEME="$HOME/.config/rofi/launchers/type-3/style-2-big-thumb.rasi"

# Target Resolution Width (e.g., 2560, 3840)
TARGET_WIDTH=2560

# Upscaler Binary and Model
UPSCALER_BIN="realesrgan-ncnn-vulkan"
UPSCALE_MODEL="realesrgan-x4plus-anime"

# --- Transition Settings ---
# Options: "random", "simple", "fade", "left", "right", "top", "bottom", "wipe", "wave", "grow", "center", "outer"
TRANSITION_TYPE="random"
TRANSITION_FPS=60
TRANSITION_DURATION=2

# Dependencies
DEPENDENCIES=("rofi" "swww" "identify" "convert" "$UPSCALER_BIN" "notify-send")

# ==============================================================================
# FUNCTIONS
# ==============================================================================

show_usage() {
    echo "Usage: wally [OPTIONS] [COMMAND]"
    echo ""
    echo "Options:"
    echo "  -u, --upscale    Enable AI upscaling (disabled by default)"
    echo "  -h, --help       Show this help message"
    echo ""
    echo "Commands:"
    echo "  (empty)          Open Rofi selection menu"
    echo "  set <image>      Directly set a wallpaper (filename or path)"
}

send_notify() {
    local title="$1"
    local message="$2"
    local urgency="${3:-normal}"
    local icon="$4"

    if command -v notify-send &> /dev/null; then
        if [ -n "$icon" ]; then
            notify-send "$title" "$message" -u "$urgency" -i "$icon"
        else
            notify-send "$title" "$message" -u "$urgency"
        fi
    else
        echo "[Wally - $urgency] $title: $message" >&2
    fi
}

# Variable to hold the calculated transition string
FINAL_TRANSITION_FLAGS=""

apply_wallpaper() {
    swww img "$DEFAULT_WALLPAPER" $FINAL_TRANSITION_FLAGS
}

# ==============================================================================
# ARGUMENT PARSING
# ==============================================================================

ENABLE_UPSCALE=false
DIRECT_INPUT=""

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -u|--upscale) ENABLE_UPSCALE=true ;;
        -h|--help) show_usage; exit 0 ;;
        set)
            if [ -n "$2" ]; then
                DIRECT_INPUT="$2"
                shift
            else
                echo "Error: 'set' requires a filename or path."
                exit 1
            fi
            ;;
        *) ;;
    esac
    shift
done

# ==============================================================================
# DEPENDENCY GUARD & TRANSITION SETUP
# ==============================================================================

# 1. Check Dependencies
missing_deps=()
for cmd in "${DEPENDENCIES[@]}"; do
    if ! command -v "$cmd" &> /dev/null; then
        missing_deps+=("$cmd")
    fi
done

if [ ${#missing_deps[@]} -gt 0 ]; then
    error_msg="Missing dependencies: ${missing_deps[*]}"
    notify-send "Wally Error" "$error_msg" -u critical
    exit 1
fi

# 2. Setup Transition Logic
if [ "$TRANSITION_TYPE" == "random" ]; then
    TRANS_LIST=("simple" "fade" "left" "right" "top" "bottom" "wipe" "wave" "grow" "center" "outer")
    RAND_IDX=$((RANDOM % ${#TRANS_LIST[@]}))
    SELECTED_TYPE="${TRANS_LIST[$RAND_IDX]}"
else
    SELECTED_TYPE="$TRANSITION_TYPE"
fi

FINAL_TRANSITION_FLAGS="--transition-type $SELECTED_TYPE --transition-fps $TRANSITION_FPS --transition-duration $TRANSITION_DURATION --transition-pos 0.5,0.5"

# ==============================================================================
# SELECTION LOGIC
# ==============================================================================

mkdir -p "$CACHE_DIR"
FULL_PATH=""
FILENAME=""

# CASE A: Direct CLI Set
if [ -n "$DIRECT_INPUT" ]; then
    if [ -f "$DIRECT_INPUT" ]; then
        FULL_PATH="$DIRECT_INPUT"
        FILENAME=$(basename "$FULL_PATH")
    elif [ -f "$WALLPAPER_DIR/$DIRECT_INPUT" ]; then
        FULL_PATH="$WALLPAPER_DIR/$DIRECT_INPUT"
        FILENAME="$DIRECT_INPUT"
    else
        send_notify "Wally Error" "Image not found: $DIRECT_INPUT" "critical"
        exit 1
    fi

# CASE B: Rofi Interactive Menu
else
    rofi_list=" Random\0icon\x1fmedia-playlist-shuffle"

    while IFS= read -r -d '' file; do
        fname=$(basename "$file")
        rofi_list+="\n$fname\0icon\x1f$file"
    done < <(find "$WALLPAPER_DIR" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) -print0 | sort -z)

    if [ "$rofi_list" == " Random\0icon\x1fmedia-playlist-shuffle" ]; then
         send_notify "Wally Error" "No images found in $WALLPAPER_DIR" "critical"
         exit 1
    fi

    selected=$(echo -en "$rofi_list" | rofi -dmenu -i -p "󰋵 " -theme "$ROFI_THEME")

    [ -z "$selected" ] && exit 0

    if [ "$selected" == " Random" ]; then
        FULL_PATH=$(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) | shuf -n 1)
        FILENAME=$(basename "$FULL_PATH")
    else
        FULL_PATH="$WALLPAPER_DIR/$selected"
        FILENAME="$selected"
    fi
fi

[ ! -f "$FULL_PATH" ] && { send_notify "Wally Error" "File not found." "critical"; exit 1; }

# ==============================================================================
# PHASE 1: PREPARATION & FORMAT NORMALIZATION
# ==============================================================================

send_notify "Wally" "Processing $FILENAME..." "low"

# Check extension
EXT="${FILENAME##*.}"
EXT="${EXT,,}" # Convert to lowercase

if [ "$EXT" != "png" ]; then
    # Construct new path with .png extension
    NEW_PATH="${FULL_PATH%.*}.png"

    send_notify "Wally" "Converting original to PNG..." "low"

    # Convert using ImageMagick
    convert "$FULL_PATH" "$NEW_PATH"

    if [ $? -eq 0 ] && [ -f "$NEW_PATH" ]; then
        # If conversion successful:
        # 1. Remove the old non-png file
        rm "$FULL_PATH"

        # 2. Update variables to point to the new PNG
        FULL_PATH="$NEW_PATH"
        FILENAME=$(basename "$NEW_PATH")

        # 3. Update the 'default.png' link
        cp "$FULL_PATH" "$DEFAULT_WALLPAPER"
    else
        send_notify "Wally Error" "Format conversion failed." "critical"
        # Fallback: just copy original to default without replacing source
        convert "$FULL_PATH" "$DEFAULT_WALLPAPER"
    fi
else
    # It is already a PNG, just copy to default location
    cp "$FULL_PATH" "$DEFAULT_WALLPAPER"
fi

# Apply immediately (Instant Preview)
apply_wallpaper

# ==============================================================================
# PHASE 2: OPTIONAL UPSCALING
# ==============================================================================

if [ "$ENABLE_UPSCALE" = true ]; then

    FILENAME_NO_EXT="${FILENAME%.*}"
    CACHE_FILE="$CACHE_DIR/${FILENAME_NO_EXT}_upscaled.png"
    CURRENT_WIDTH=$(identify -format "%w" "$FULL_PATH")

    if [ "$CURRENT_WIDTH" -lt "$TARGET_WIDTH" ]; then
        if [ -f "$CACHE_FILE" ]; then
            cp "$CACHE_FILE" "$DEFAULT_WALLPAPER"
            apply_wallpaper
            send_notify "Wally" "High-res loaded from cache." "low" "$DEFAULT_WALLPAPER"
        else
            send_notify "Wally" "Upscaling background (x4)..." "normal"

            "$UPSCALER_BIN" -i "$FULL_PATH" -o "$CACHE_FILE" -n "$UPSCALE_MODEL"

            if [ $? -eq 0 ]; then
                cp "$CACHE_FILE" "$DEFAULT_WALLPAPER"
                apply_wallpaper
                send_notify "Wally" "Upscale complete & applied." "low" "$DEFAULT_WALLPAPER"
            else
                send_notify "Wally Error" "Upscaling failed. Keeping preview." "critical"
            fi
        fi
    else
        send_notify "Wally" "Resolution optimal (Upscale skipped)." "low" "$DEFAULT_WALLPAPER"
    fi
fi
