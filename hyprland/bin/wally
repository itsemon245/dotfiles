#!/usr/bin/env bash

# ==============================================================================
# CONFIGURATION
# ==============================================================================

# Directory containing your wallpapers
WALLPAPER_DIR="$HOME/Wallpapers"

OPENRGB_SCRIPT="$HOME/.config/OpenRGB/scripts/wallust-colors.sh"

#SDDM theme directory
SDDM_THEME_DIR="/usr/share/sddm/themes/silent"

# The specific file Hyprland/swww should always look at
DEFAULT_WALLPAPER="$WALLPAPER_DIR/default.png"

# Directory to cache upscaled images
CACHE_DIR="$HOME/.cache/wally"

# Rofi Theme Path
ROFI_THEME="$HOME/.config/rofi/launchers/type-3/style-2-big-thumb.rasi"

# Target Resolution Width (e.g., 2560 for 1440p, 1920 for 1080p)
# The final image will be resized to this width to save space.
TARGET_WIDTH=2560

# --- UPSCALER SETTINGS ---
UPSCALER_BIN="realesrgan-ncnn-vulkan"
UPSCALE_MODEL="realesrgan-x4plus-anime"

# --- Transition Settings ---
TRANSITION_TYPE="random"
TRANSITION_FPS=60
TRANSITION_DURATION=2

# Dependencies
DEPENDENCIES=("rofi" "swww" "identify" "convert" "$UPSCALER_BIN" "dunstify" "wallust")

# Fixed Notification ID
NOTIF_ID=991011

# ==============================================================================
# FUNCTIONS
# ==============================================================================

show_usage() {
    echo "Usage: wally [OPTIONS] [COMMAND]"
    echo "Options:"
    echo "  -u, --upscale    Enable AI upscaling (if not already cached)"
    echo "  --no-upscale     Force original image (ignore cache)"
    echo "Commands:"
    echo "  (empty)          Open Rofi menu"
    echo "  set <image>      Directly set a wallpaper"
}

notify_progress() {
    local pct="$1"
    local msg="$2"
    local urgency="${3:-low}"
    local icon_path="${FULL_PATH:-image-x-generic}"

    dunstify "   Wally" "$msg" \
        -r "$NOTIF_ID" \
        -u "$urgency" \
        -h int:value:"$pct" \
        -i "$icon_path" \
        -t 0
}

notify_done() {
    local icon_path="${FULL_PATH:-image-x-generic}"

    dunstify "   Wally" "$1" \
        -r "$NOTIF_ID" \
        -u "low" \
        -h int:value:100 \
        -i "$icon_path" \
        -t 5000
}

update_system_theme() {
    local img="$1"

    notify_progress 70 "Generating colors..." "low"

    wallust run "$img" -q

    # Reload Apps
    pkill waybar && hyprctl dispatch exec waybar
    killall dunst
    killall -SIGUSR1 kitty

    if pgrep -x "qt5ct" > /dev/null; then
        killall -SIGUSR1 qt5ct
    fi

     # --- NEW: Force GTK Reload ---
    # We toggle the theme setting quickly. This forces running GTK apps to re-read CSS.
    # Note: Requires 'glib2' package (which has gsettings), usually installed by default.
    current_theme=$(gsettings get org.gnome.desktop.interface gtk-theme)
    # Strip single quotes
    current_theme=${current_theme//\'/}

    # Switch to Default and back to current to trigger repaint
    gsettings set org.gnome.desktop.interface gtk-theme "Default"
    sleep 0.1
    gsettings set org.gnome.desktop.interface gtk-theme "$current_theme"
}

FINAL_TRANSITION_FLAGS=""

apply_wallpaper() {
    swww img "$DEFAULT_WALLPAPER" $FINAL_TRANSITION_FLAGS
    update_system_theme "$DEFAULT_WALLPAPER"

    #OpenRGB colors
    if [ -f "$OPENRGB_SCRIPT" ] && command -v openrgb &> /dev/null; then
        chmod +x "$OPENRGB_SCRIPT"
        "$OPENRGB_SCRIPT"
    fi


    #Copy the wallpaper into sddm slient theme backgrounds
    #cp "$DEFAULT_WALLPAPER" "$SDDM_THEME_DIR/backgrounds/default.png"

}

# ==============================================================================
# ARGUMENT PARSING
# ==============================================================================

ENABLE_UPSCALE=false
FORCE_ORIGINAL=false
DIRECT_INPUT=""

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -u|--upscale) ENABLE_UPSCALE=true ;;
        --no-upscale) FORCE_ORIGINAL=true ;;
        -h|--help) show_usage; exit 0 ;;
        set)
            if [ -n "$2" ]; then
                DIRECT_INPUT="$2"
                shift
            else
                dunstify "   Wally Error" "'set' requires a filename." -u critical
                exit 1
            fi
            ;;
        *) ;;
    esac
    shift
done

# ==============================================================================
# CHECKS & SETUP
# ==============================================================================

missing_deps=()
for cmd in "${DEPENDENCIES[@]}"; do
    if ! command -v "$cmd" &> /dev/null; then
        missing_deps+=("$cmd")
    fi
done

if [ ${#missing_deps[@]} -gt 0 ]; then
    dunstify "   Wally Error" "Missing: ${missing_deps[*]}" -u critical
    exit 1
fi

if [ "$TRANSITION_TYPE" == "random" ]; then
    TRANS_LIST=("simple" "fade" "left" "right" "top" "bottom" "wipe" "wave" "grow" "center" "outer")
    RAND_IDX=$((RANDOM % ${#TRANS_LIST[@]}))
    SELECTED_TYPE="${TRANS_LIST[$RAND_IDX]}"
else
    SELECTED_TYPE="$TRANSITION_TYPE"
fi

FINAL_TRANSITION_FLAGS="--transition-type $SELECTED_TYPE --transition-fps $TRANSITION_FPS --transition-duration $TRANSITION_DURATION --transition-pos 0.5,0.5"

mkdir -p "$CACHE_DIR"

# ==============================================================================
# SELECTION LOGIC
# ==============================================================================

FULL_PATH=""
FILENAME=""

# CASE A: Direct CLI Set
if [ -n "$DIRECT_INPUT" ]; then
    if [ -f "$DIRECT_INPUT" ]; then
        FULL_PATH="$DIRECT_INPUT"
        FILENAME=$(basename "$FULL_PATH")
    elif [ -f "$WALLPAPER_DIR/$DIRECT_INPUT" ]; then
        FULL_PATH="$WALLPAPER_DIR/$DIRECT_INPUT"
        FILENAME="$DIRECT_INPUT"
    else
        dunstify "   Wally Error" "Image not found: $DIRECT_INPUT" -u critical
        exit 1
    fi

# CASE B: Rofi Interactive Menu
else
    rofi_list=" Random\0icon\x1fmedia-playlist-shuffle"

    while IFS= read -r -d '' file; do
        fname=$(basename "$file")
        rofi_list+="\n$fname\0icon\x1f$file"
    done < <(find "$WALLPAPER_DIR" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) -print0 | sort -z)

    if [ "$rofi_list" == " Random\0icon\x1fmedia-playlist-shuffle" ]; then
         dunstify "   Wally Error" "No images found in $WALLPAPER_DIR" -u critical
         exit 1
    fi

    selected=$(echo -en "$rofi_list" | rofi -dmenu -i -p "󰋵 " -theme "$ROFI_THEME")

    [ -z "$selected" ] && exit 0

    if [ "$selected" == " Random" ]; then
        FULL_PATH=$(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) | shuf -n 1)
        FILENAME=$(basename "$FULL_PATH")
    else
        FULL_PATH="$WALLPAPER_DIR/$selected"
        FILENAME="$selected"
    fi
fi

[ ! -f "$FULL_PATH" ] && { dunstify "   Wally Error" "File not found." -u critical; exit 1; }

# ==============================================================================
# PHASE 1: PREPARATION & NORMALIZATION
# ==============================================================================

notify_progress 10 "Initializing..." "low"

EXT="${FILENAME##*.}"
EXT="${EXT,,}"

if [ "$EXT" != "png" ]; then
    NEW_PATH="${FULL_PATH%.*}.png"
    notify_progress 20 "Normalizing to PNG..." "low"
    convert "$FULL_PATH" "$NEW_PATH"

    if [ $? -eq 0 ] && [ -f "$NEW_PATH" ]; then
        rm "$FULL_PATH"
        FULL_PATH="$NEW_PATH"
        FILENAME=$(basename "$NEW_PATH")
        cp "$FULL_PATH" "$DEFAULT_WALLPAPER"
    else
        dunstify "   Wally Error" "Format conversion failed." -u critical
        convert "$FULL_PATH" "$DEFAULT_WALLPAPER"
    fi
else
    cp "$FULL_PATH" "$DEFAULT_WALLPAPER"
fi

notify_progress 30 "Setting preview..." "low"
apply_wallpaper

# ==============================================================================
# PHASE 2: INTELLIGENT SELECTION & RESIZING
# ==============================================================================

FILENAME_NO_EXT="${FILENAME%.*}"
CACHE_FILE="$CACHE_DIR/${FILENAME_NO_EXT}_upscaled.png"

# PATH 1: Force Original
if [ "$FORCE_ORIGINAL" = true ]; then
    notify_done "Original Wallpaper Set (Forced)."
    exit 0
fi

# PATH 2: Check Cache
if [ -f "$CACHE_FILE" ]; then
    notify_progress 80 "Found cached high-res..." "low"
    cp "$CACHE_FILE" "$DEFAULT_WALLPAPER"
    apply_wallpaper
    notify_done "Cached Wallpaper Set."
    exit 0
fi

# PATH 3: Upscaling + Downsizing
if [ "$ENABLE_UPSCALE" = true ]; then

    notify_progress 50 "Upscaling..." "low"

    # Temporary file for the raw huge AI output (4x native)
    TEMP_UPSCALE="$CACHE_DIR/temp_${FILENAME_NO_EXT}.png"

    # 1. Upscale using AI (Scale factor 4 = Native. Tile size 400 for speed on 3060 Ti)
    "$UPSCALER_BIN" -i "$FULL_PATH" -o "$TEMP_UPSCALE" -n "$UPSCALE_MODEL" -s 4 -t 400

    if [ $? -eq 0 ]; then
        notify_progress 60 "Optimizing Size..." "low"

        # 2. Resize DOWN to target monitor width (2560px)
        # This keeps the sharpness but fixes the file size and grid artifacts
        convert "$TEMP_UPSCALE" -resize "$TARGET_WIDTH"x "$CACHE_FILE"

        # Cleanup huge temp file
        rm "$TEMP_UPSCALE"

        if [ -f "$CACHE_FILE" ]; then
            notify_progress 90 "Applying Upscale..." "low"
            cp "$CACHE_FILE" "$DEFAULT_WALLPAPER"
            apply_wallpaper
            notify_done "Wallpaper Set."
        else
             dunstify "   Wally Error" "Optimization failed." -u critical
        fi
    else
        dunstify "   Wally Error" "Upscaling failed." -u critical
        [ -f "$TEMP_UPSCALE" ] && rm "$TEMP_UPSCALE"
    fi

else
    notify_done "Wallpaper Set."
fi
