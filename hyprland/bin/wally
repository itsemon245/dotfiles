#!/usr/bin/env bash

# ==============================================================================
# CONFIGURATION
# ==============================================================================

# Directory containing your wallpapers
WALLPAPER_DIR="$HOME/Wallpapers"

# The specific file Hyprland/swww should always look at
DEFAULT_WALLPAPER="$WALLPAPER_DIR/default.png"

# Directory to cache upscaled images
CACHE_DIR="$HOME/.cache/wally"

# Rofi Theme Path
ROFI_THEME="$HOME/.config/rofi/launchers/type-3/style-2-big-thumb.rasi"

# --- UPSCALER SETTINGS ---
UPSCALER_BIN="realesrgan-ncnn-vulkan"
UPSCALE_MODEL="realesrgan-x4plus-anime"

# --- Transition Settings ---
TRANSITION_TYPE="random"
TRANSITION_FPS=60
TRANSITION_DURATION=2

# Dependencies
DEPENDENCIES=("rofi" "swww" "identify" "convert" "$UPSCALER_BIN" "dunstify")

# Fixed Notification ID
NOTIF_ID=991011

# ==============================================================================
# FUNCTIONS
# ==============================================================================

show_usage() {
    echo "Usage: wally [OPTIONS] [COMMAND]"
    echo "Options:"
    echo "  -u, --upscale    Enable AI upscaling (if not already cached)"
    echo "  --no-upscale     Force original image (ignore cache)"
    echo "Commands:"
    echo "  (empty)          Open Rofi menu"
    echo "  set <image>      Directly set a wallpaper"
}

notify_progress() {
    local pct="$1"
    local msg="$2"
    local urgency="${3:-low}"

    # We use the FULL_PATH (the wallpaper image itself) as the notification icon
    # Fallback to 'image-x-generic' if variable is empty
    local icon_path="${FULL_PATH:-image-x-generic}"

    # -t 0 : FORCE the notification to stay open
    dunstify "   Wally" "$msg" \
        -r "$NOTIF_ID" \
        -u "$urgency" \
        -h int:value:"$pct" \
        -i "$icon_path" \
        -t 0
}

notify_done() {
    local icon_path="${FULL_PATH:-image-x-generic}"

    # -t 5000 : Close after 5s
    dunstify "   Wally" "$1" \
        -r "$NOTIF_ID" \
        -u "low" \
        -h int:value:100 \
        -i "$icon_path" \
        -t 5000
}

FINAL_TRANSITION_FLAGS=""

apply_wallpaper() {
    swww img "$DEFAULT_WALLPAPER" $FINAL_TRANSITION_FLAGS
}

# ==============================================================================
# ARGUMENT PARSING
# ==============================================================================

ENABLE_UPSCALE=false
FORCE_ORIGINAL=false
DIRECT_INPUT=""

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -u|--upscale) ENABLE_UPSCALE=true ;;
        --no-upscale) FORCE_ORIGINAL=true ;;
        -h|--help) show_usage; exit 0 ;;
        set)
            if [ -n "$2" ]; then
                DIRECT_INPUT="$2"
                shift
            else
                dunstify "   Wally Error" "'set' requires a filename." -u critical
                exit 1
            fi
            ;;
        *) ;;
    esac
    shift
done

# ==============================================================================
# DEPENDENCY GUARD & TRANSITION SETUP
# ==============================================================================

missing_deps=()
for cmd in "${DEPENDENCIES[@]}"; do
    if ! command -v "$cmd" &> /dev/null; then
        missing_deps+=("$cmd")
    fi
done

if [ ${#missing_deps[@]} -gt 0 ]; then
    dunstify "   Wally Error" "Missing: ${missing_deps[*]}" -u critical
    exit 1
fi

if [ "$TRANSITION_TYPE" == "random" ]; then
    TRANS_LIST=("simple" "fade" "left" "right" "top" "bottom" "wipe" "wave" "grow" "center" "outer")
    RAND_IDX=$((RANDOM % ${#TRANS_LIST[@]}))
    SELECTED_TYPE="${TRANS_LIST[$RAND_IDX]}"
else
    SELECTED_TYPE="$TRANSITION_TYPE"
fi

FINAL_TRANSITION_FLAGS="--transition-type $SELECTED_TYPE --transition-fps $TRANSITION_FPS --transition-duration $TRANSITION_DURATION --transition-pos 0.5,0.5"

# ==============================================================================
# SELECTION LOGIC
# ==============================================================================

mkdir -p "$CACHE_DIR"
FULL_PATH=""
FILENAME=""

# CASE A: Direct CLI Set
if [ -n "$DIRECT_INPUT" ]; then
    if [ -f "$DIRECT_INPUT" ]; then
        FULL_PATH="$DIRECT_INPUT"
        FILENAME=$(basename "$FULL_PATH")
    elif [ -f "$WALLPAPER_DIR/$DIRECT_INPUT" ]; then
        FULL_PATH="$WALLPAPER_DIR/$DIRECT_INPUT"
        FILENAME="$DIRECT_INPUT"
    else
        dunstify "   Wally Error" "Image not found: $DIRECT_INPUT" -u critical
        exit 1
    fi

# CASE B: Rofi Interactive Menu
else
    rofi_list=" Random\0icon\x1fmedia-playlist-shuffle"

    while IFS= read -r -d '' file; do
        fname=$(basename "$file")
        rofi_list+="\n$fname\0icon\x1f$file"
    done < <(find "$WALLPAPER_DIR" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) -print0 | sort -z)

    if [ "$rofi_list" == " Random\0icon\x1fmedia-playlist-shuffle" ]; then
         dunstify "   Wally Error" "No images found in $WALLPAPER_DIR" -u critical
         exit 1
    fi

    selected=$(echo -en "$rofi_list" | rofi -dmenu -i -p "󰋵 " -theme "$ROFI_THEME")

    [ -z "$selected" ] && exit 0

    if [ "$selected" == " Random" ]; then
        FULL_PATH=$(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) | shuf -n 1)
        FILENAME=$(basename "$FULL_PATH")
    else
        FULL_PATH="$WALLPAPER_DIR/$selected"
        FILENAME="$selected"
    fi
fi

[ ! -f "$FULL_PATH" ] && { dunstify "   Wally Error" "File not found." -u critical; exit 1; }

# ==============================================================================
# PHASE 1: PREPARATION & FORMAT NORMALIZATION
# ==============================================================================

notify_progress 10 "Initializing..." "low"

# Normalize to PNG
EXT="${FILENAME##*.}"
EXT="${EXT,,}"

if [ "$EXT" != "png" ]; then
    NEW_PATH="${FULL_PATH%.*}.png"
    notify_progress 20 "Normalizing to PNG..." "low"
    convert "$FULL_PATH" "$NEW_PATH"

    if [ $? -eq 0 ] && [ -f "$NEW_PATH" ]; then
        rm "$FULL_PATH"
        FULL_PATH="$NEW_PATH"
        FILENAME=$(basename "$NEW_PATH")
        cp "$FULL_PATH" "$DEFAULT_WALLPAPER"
    else
        dunstify "   Wally Error" "Format conversion failed." -u critical
        convert "$FULL_PATH" "$DEFAULT_WALLPAPER"
    fi
else
    cp "$FULL_PATH" "$DEFAULT_WALLPAPER"
fi

notify_progress 30 "Setting preview..." "low"
apply_wallpaper

# ==============================================================================
# PHASE 2: INTELLIGENT SELECTION
# ==============================================================================

FILENAME_NO_EXT="${FILENAME%.*}"
CACHE_FILE="$CACHE_DIR/${FILENAME_NO_EXT}_upscaled.png"

# PATH 1: Force Original
if [ "$FORCE_ORIGINAL" = true ]; then
    notify_done "Original Wallpaper Set (Forced)."
    exit 0
fi

# PATH 2: Check Cache (Automatic)
if [ -f "$CACHE_FILE" ]; then
    notify_progress 80 "Found cached high-res..." "low"
    cp "$CACHE_FILE" "$DEFAULT_WALLPAPER"
    apply_wallpaper
    notify_done "Cached Wallpaper Set."
    exit 0
fi

# PATH 3: Upscaling (If requested + No cache)
if [ "$ENABLE_UPSCALE" = true ]; then

    notify_progress 50 "Upscaling..." "low"

    "$UPSCALER_BIN" -i "$FULL_PATH" -o "$CACHE_FILE" -n "$UPSCALE_MODEL"

    if [ $? -eq 0 ]; then
        notify_progress 90 "Applying Upscale..." "low"
        cp "$CACHE_FILE" "$DEFAULT_WALLPAPER"
        apply_wallpaper
        notify_done "Wallpaper Set."
    else
        dunstify "   Wally Error" "Upscaling failed." -u critical
    fi

else
    notify_done "Wallpaper Set."
fi
