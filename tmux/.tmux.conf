##### Basic Settings #####

set -g base-index 1
setw -g pane-base-index 1
setw -g aggressive-resize off
setw -g clock-mode-style 12
set -g mouse on
set -g history-limit 10000
set -s escape-time 10
set -g status-keys vi
set -g mode-keys vi

# Set default terminal (fallback-friendly)
set -g default-terminal "screen-256color"
set-option -ga terminal-overrides ",xterm-256color:RGB,xterm*:Tc"

# Set default shell based on availability
run-shell 'if command -v zsh >/dev/null 2>&1; then \
  tmux set-option -g default-shell "$(command -v zsh)"; \
else \
  tmux set-option -g default-shell "$(command -v bash)"; \
fi'

##### Prefix & Keybindings #####

unbind C-b
set -g prefix C-Space
bind -N "Send the prefix key through to the application" Space send-prefix
bind C-Space last-window

bind-key -N "Kill the current window" & kill-window
bind-key -N "Kill the current pane" x kill-pane

bind '-' split-window -v -c "#{pane_current_path}"
bind '\' split-window -h -c "#{pane_current_path}"
bind C-k send-keys "clear" \; send-keys Enter

is_vim='echo "#{pane_current_command}" | grep -iqE "(^|\/)g?(view|n?vim?)(diff)?$"'
bind -n C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"

bind-key -r F new-window -c "#{pane_current_path}"
bind-key -r D run-shell "t ~/dotfiles"

bind Space last-window

bind -n M-H previous-window
bind -n M-L next-window

##### Status Bar Colors (Environment-based) #####

# Wallust Colors
source-file ~/.tmux-colors.conf
# set -g @status_bg             "#292c3c"   # Consistent background for all environments
# set -g @status_fg_default     "#babbf1"   # Default foreground color

# Dynamic status bar foreground based on APP_ENV (from .env file or environment)
# Uses tmux-scripts directory in home folder
set -g status-style "fg=#(bash ~/.tmux-scripts/tmux-get-env),bg=#{@status_bg}"

set-option -g pane-base-index 1
set-option -g renumber-windows on
set-option -g status-position top
set-option -g status-left-length 100
set-option -g status-right-length 100
set-option -g status-left " #{session_name}  "
set-option -g status-right "#{user}@#{host}"
set -g status-justify centre
set-option -g window-status-format " #{window_index}:#{window_name}#{window_flags} "
set-option -g window-status-current-format " #{window_index}:#{window_name}#{window_flags} "
# set-option -g window-status-current-style "fg=#ca9ee6"
set-option -g window-status-activity-style none

##### Plugin Management (TPM) #####

# TPM is optional: only load if installed
if-shell '[ -d ~/.tmux/plugins/tpm ]' {
  set -g @plugin 'tmux-plugins/tpm'
  set -g @plugin 'tmux-plugins/tmux-sensible'
  set -g @plugin 'tmux-plugins/tmux-yank'
  set -g @plugin 'tmux-plugins/tmux-prefix-highlight'

  # Only load tmux-open if xdg-open is available
  #if-shell 'command -v xdg-open >/dev/null 2>&1' {
  #  set -g @plugin 'tmux-plugins/tmux-open'
  #}

  set -g @plugin 'tmux-plugins/tmux-net-speed'
  set -g @plugin 'tmux-plugins/tmux-better-mouse-mode'
  set -g @plugin 'tmux-plugins/tmux-copycat'
  set -g @plugin 'tmux-plugins/tmux-resurrect'
  set -g @plugin 'tmux-plugins/tmux-continuum'
  set -g @plugin 'christoomey/vim-tmux-navigator'

  run '~/.tmux/plugins/tpm/tpm'
  set -g @continuum-restore 'on'
  set -g @continuum-save-interval '60'
}
