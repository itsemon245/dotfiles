#!/bin/bash

STATE_FILE="/tmp/net_bytes_last"
INTERFACE=$(route get default 2>/dev/null | awk '/interface: / {print $2}')

# Get current byte count
CURRENT=$(netstat -bI "$INTERFACE" 2>/dev/null | awk -v iface="$INTERFACE" '$1 == iface {print $7}' | head -n 1)

# Exit if CURRENT is empty
if ! [[ "$CURRENT" =~ ^[0-9]+$ ]]; then
  echo "Unable to read byte count for interface: $INTERFACE"
  exit 1
fi

# Read previous count
if [ -f "$STATE_FILE" ]; then
  LAST=$(cat "$STATE_FILE")
else
  LAST=$CURRENT
fi

# Store current for next run
echo "$CURRENT" > "$STATE_FILE"

# Compute delta
BYTES=$((CURRENT - LAST))

# Output
if [ "$BYTES" -lt 1024 ]; then
  echo "${BYTES} B/s"
elif [ "$BYTES" -lt 1048576 ]; then
  printf "%.0f KB/s\n" "$(echo "$BYTES / 1024" | bc -l)"
else
  printf "%.2f MB/s\n" "$(echo "$BYTES / 1048576" | bc -l)"
fi
